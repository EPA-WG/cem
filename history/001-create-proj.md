guide me to create github hosted Nx based monorepo with yarn package manager. 
Sub-projects are:
* @epa-wg/cem-theme 
* @epa-wg/cem-components
The release cycle and versioning would be synchronous for both. Npm published packages individual. 
Create canvas with guide.

---

# Nx + Yarn Monorepo Guide for `@epa-wg/cem-theme` and `@epa-wg/cem-components`

## Target state

* Single GitHub repository (Nx workspace) using **Yarn**.
* Two publishable packages:

  * `@epa-wg/cem-theme`
  * `@epa-wg/cem-components`
* **Synchronous versioning** (both packages share the same version each release).
* **Individual npm publishes** (each package publishes its own tarball).

---

## 0) Prerequisites

### 0.1 Toolchain

* Node.js (recommend **Active LTS**)
* Git
* npm account with permissions to publish to scope `@epa-wg`

### 0.2 GitHub + npm prep

1. Create a **new GitHub repository** (e.g., `epa-wg/cem` or `epa-wg/cem-monorepo`).
2. In npm:

   * Ensure the `@epa-wg` scope exists.
   * Ensure your user/service account has publish rights.
   * Create an automation token for CI (`NPM_ACCESS_TOKEN`).

---

## 1) Create the Nx workspace (Yarn)

From an empty directory:

```bash
# Option A: interactive (recommended)
npx create-nx-workspace@latest

# When prompted:
# - Choose a workspace name (e.g. cem)
# - Choose a preset appropriate for TS libs (TypeScript / Empty / Integrated)
# - Choose package manager: yarn
```

Or non-interactive (example):

```bash
npx create-nx-workspace@latest cem --packageManager=yarn
cd cem
```

Initialize git if needed:

```bash
git init
```

---

## 2) Configure Yarn (recommended defaults)

### 2.1 Use Corepack + pin Yarn

```bash
corepack enable
# Pin to the stable Yarn line (writes to .yarn/releases and package.json "packageManager")
yarn set version stable
```

### 2.2 Choose installation strategy

**Recommended for broad tooling compatibility:** `node_modules` linker.

Create/adjust `.yarnrc.yml`:

```yaml
nodeLinker: node-modules
```

Install:

```bash
yarn install
```

Commit the lockfile (and the Yarn release file produced by `yarn set version stable`).

---

## 3) Create publishable packages

We will create publishable libraries under `packages/*`.

### 3.1 `@epa-wg/cem-theme`

```bash
yarn nx g @nx/js:library packages/cem-theme \
  --publishable \
  --importPath=@epa-wg/cem-theme \
  --bundler=tsc \
  --projectNameAndRootFormat=as-provided
```

### 3.2 `@epa-wg/cem-components`

```bash
yarn nx g @nx/js:library packages/cem-components \
  --publishable \
  --importPath=@epa-wg/cem-components \
  --bundler=tsc \
  --projectNameAndRootFormat=as-provided
```

### 3.3 Wire dependencies (if `cem-components` consumes `cem-theme`)

In `packages/cem-components/package.json`:

* Add dependency on `@epa-wg/cem-theme`.
* For the very first release, it is acceptable to use a placeholder version and let Nx Release rewrite it when you cut the release.

Example placeholder:

```json
{
  "dependencies": {
    "@epa-wg/cem-theme": "0.0.0"
  }
}
```

After you run your first `nx release`, the dependency range will be updated to the released version (using your configured `versionPrefix`).

### 3.4 Ensure npm publish config is correct for scoped packages

In each package’s `package.json` (generated by Nx), confirm:

* `name` is correct (`@epa-wg/...`).
* `private` is **not** set to `true`.
* `publishConfig` includes access:

```json
{
  "publishConfig": {
    "access": "public"
  }
}
```

---

## 4) Validate local build

```bash
# Build both
yarn nx run cem-theme:build
yarn nx run cem-components:build

# (Optional) lint/test if configured
yarn nx run-many -t lint,test

# View dependency graph
yarn nx graph
```

---

## 5) Configure synchronous versioning with Nx Release

Nx Release supports **release groups**. We will configure a single **fixed** group containing both packages.

### 5.1 `nx.json`

Add (or merge) the following:

```json
{
  "release": {
    "groups": {
      "cem": {
        "projects": [
          "cem-theme",
          "cem-components"
        ],
        "projectsRelationship": "fixed",
        "releaseTag": {
          "pattern": "v{version}",
          "requireSemver": true
        },
        "version": {
          "conventionalCommits": true,
          "updateDependents": "auto",
          "versionPrefix": "^"
        }
      }
    }
  }
}
```

Notes:

* `projectsRelationship: "fixed"` enforces **lock-step** versioning.
* `releaseTag.pattern: "v{version}"` yields a single tag per release.
* `updateDependents: "auto"` keeps intra-workspace dependency ranges updated.

### 5.2 Local release flow (recommended)

1. Make changes on a branch and merge to `main`.
2. From `main`, run versioning + changelog generation **without publishing**:

```bash
yarn nx release --skip-publish
```

3. Push the resulting commit + tag:

```bash
git push
git push --tags
```

Publishing will be handled by GitHub Actions (next section).

---

## 6) GitHub Actions

### 6.1 CI workflow (PR + main)

Create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Nx report
        run: yarn nx report

      - name: Lint + Test + Build (affected)
        run: |
          yarn nx affected -t lint,test,build --parallel=3
```

### 6.2 Publish workflow (tags)

Create `.github/workflows/publish.yml`:

```yaml
name: Publish

on:
  push:
    tags:
      - v*.*.*

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # for npm provenance

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org/

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Publish packages
        run: yarn nx release publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
```

### 6.3 Required repository secret

In GitHub repo settings, add:

* `NPM_ACCESS_TOKEN` (npm automation token with publish rights to `@epa-wg/*`).

---

## 7) Recommended repo conventions

### 7.1 Conventional commits

If you enable `conventionalCommits: true`, use conventional commits to drive versioning:

* `feat:` → minor
* `fix:` → patch
* `feat!:` or `BREAKING CHANGE:` → major

### 7.2 Branch protection

Recommended `main` rules:

* Require PRs
* Require CI to pass
* Require linear history (optional)
* Restrict who can push (optional)

---

## 8) Common commands

```bash
# Run tasks
yarn nx graph
yarn nx run cem-theme:build
yarn nx run cem-components:build

# Affected (best in CI)
yarn nx affected -t lint,test,build

# Release (local) – creates version commit + tag; skip publishing
yarn nx release --skip-publish

# Release (CI) – publish only
yarn nx release publish
```
